<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Creation Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }

        .section h2 {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .script-editor {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            background: white;
        }

        .script-editor:focus {
            outline: none;
            border-color: #667eea;
        }

        .avatar-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .avatar-option {
            text-align: center;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .avatar-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .avatar-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .avatar-option img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .avatar-name {
            font-size: 0.9rem;
            color: #333;
            font-weight: 500;
        }

        .voice-settings {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .setting-group {
            flex: 1;
            min-width: 200px;
        }

        .setting-group label {
            display: block;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .setting-group select,
        .setting-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .setting-group select:focus,
        .setting-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .images-preview {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .image-thumbnail {
            flex-shrink: 0;
            width: 150px;
            height: 150px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            position: relative;
        }

        .image-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-thumbnail .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 59, 48, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            line-height: 1;
        }

        .word-count {
            text-align: right;
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .preview-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .preview-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
        }

        .preview-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .preview-btn.active {
            background: #667eea;
            color: white;
        }

        .avatar-preview-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .avatar-preview-title {
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
            text-align: center;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 1.2rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .video-result {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 15px;
            text-align: center;
        }

        .video-result.active {
            display: block;
        }

        .video-player {
            max-width: 800px;
            margin: 0 auto 20px;
        }

        .video-player video {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .download-btn {
            background: linear-gradient(45deg, #56ab2f 0%, #a8e063 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.3);
        }

        .progress-bar {
            display: none;
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 20px;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 AI Video Creation Studio</h1>
            <p>Transform your product into an engaging video with AI avatars</p>
        </div>

        <div class="content-grid">
            <!-- Script Section -->
            <div class="section">
                <h2>📝 Video Script</h2>
                <textarea 
                    id="videoScript" 
                    class="script-editor" 
                    placeholder="Your video script will appear here. You can edit it to perfect your message..."
                ></textarea>
                <div class="word-count">
                    Word count: <span id="wordCount">0</span> / 500
                </div>
            </div>

            <!-- Avatar Selection -->
            <div class="section">
                <h2>👤 Choose Your Avatar</h2>
                <div class="avatar-selection" id="avatarSelection">
                    <div class="avatar-option selected" data-avatar="anna" data-voice="en-US-JennyNeural">
                        <img src="https://d-id-public-bucket.s3.us-west-2.amazonaws.com/alice.jpg" alt="Anna" onerror="this.src='https://via.placeholder.com/80/9C88FF/FFFFFF?text=Anna'">
                        <div class="avatar-name">Anna</div>
                    </div>
                    <div class="avatar-option" data-avatar="james" data-voice="en-US-GuyNeural">
                        <img src="https://d-id-public-bucket.s3.us-west-2.amazonaws.com/james.jpg" alt="James" onerror="this.src='https://via.placeholder.com/80/667EEA/FFFFFF?text=James'">
                        <div class="avatar-name">James</div>
                    </div>
                    <div class="avatar-option" data-avatar="sophia" data-voice="en-US-AriaNeural">
                        <img src="https://d-id-public-bucket.s3.us-west-2.amazonaws.com/sophia.jpg" alt="Sophia" onerror="this.src='https://via.placeholder.com/80/F093FB/FFFFFF?text=Sophia'">
                        <div class="avatar-name">Sophia</div>
                    </div>
                    <div class="avatar-option" data-avatar="michael" data-voice="en-US-DavisNeural">
                        <img src="https://d-id-public-bucket.s3.us-west-2.amazonaws.com/michael.jpg" alt="Michael" onerror="this.src='https://via.placeholder.com/80/4FACFE/FFFFFF?text=Michael'">
                        <div class="avatar-name">Michael</div>
                    </div>
                </div>
                <div class="avatar-preview-section">
                    <div class="avatar-preview-title">🎤 Preview Script with Avatar Voice</div>
                    <div class="preview-controls">
                        <button class="preview-btn" id="playBtn" onclick="togglePreview()">
                            ▶️ Start
                        </button>
                        <button class="preview-btn" id="stopBtn" onclick="stopPreview()" style="display: none;">
                            ⏹️ Stop
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voice Settings -->
        <div class="section">
            <h2>🎙️ Voice Settings</h2>
            <div class="voice-settings">
                <div class="setting-group">
                    <label for="voiceLanguage">Language</label>
                    <select id="voiceLanguage">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="es-ES">Spanish</option>
                        <option value="fr-FR">French</option>
                        <option value="de-DE">German</option>
                        <option value="it-IT">Italian</option>
                        <option value="pt-BR">Portuguese (Brazil)</option>
                        <option value="zh-CN">Chinese (Mandarin)</option>
                        <option value="ja-JP">Japanese</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="voiceSpeed">Speaking Speed</label>
                    <select id="voiceSpeed">
                        <option value="0.75">Slow</option>
                        <option value="1" selected>Normal</option>
                        <option value="1.25">Fast</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="videoDuration">Video Duration</label>
                    <select id="videoDuration">
                        <option value="5">5 seconds</option>
                        <option value="15">15 seconds</option>
                        <option value="30" selected>30 seconds</option>
                        <option value="60">1 minute</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Product Images -->
        <div class="section">
            <h2>🖼️ Product Images</h2>
            <div class="images-preview" id="imagesPreview">
                <!-- Images will be loaded here -->
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="previewScript()">
                👁️ Preview Script
            </button>
            <button class="btn btn-primary" onclick="generateVideo()">
                🎥 Generate Video
            </button>
        </div>

        <!-- Video Result -->
        <div class="video-result" id="videoResult">
            <h2>🎉 Your Video is Ready!</h2>
            <div class="video-player">
                <video id="generatedVideo" controls></video>
            </div>
            <div>
                <button class="download-btn" onclick="downloadVideo()">
                    📥 Download Video
                </button>
                <button class="download-btn" onclick="shareVideo()">
                    🔗 Share Video
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Creating your video...</div>
    </div>

    <script>
        let selectedAvatar = 'anna';
        let selectedVoice = 'en-US-JennyNeural';
        let generatedVideoUrl = null;
        let speechSynthesisUtterance = null;
        let isPlaying = false;

        // Load data from sessionStorage on page load
        window.addEventListener('DOMContentLoaded', () => {
            const productName = sessionStorage.getItem('productName');
            const description = sessionStorage.getItem('productDescription');
            const features = sessionStorage.getItem('features');
            const targetAudience = sessionStorage.getItem('targetAudience');
            const imagesData = sessionStorage.getItem('generatedImages');
            
            // Generate script from product data
            let script = generateVideoScript(productName, description, features, targetAudience);
            document.getElementById('videoScript').value = script;
            updateWordCount();
            
            // Load images
            if (imagesData) {
                try {
                    const images = JSON.parse(imagesData);
                    displayImages(images);
                } catch (e) {
                    console.error('Error parsing images:', e);
                }
            }
        });

        function generateVideoScript(productName, description, features, targetAudience) {
            // Create an engaging video script from the product data
            let script = `Welcome to ${productName || 'our amazing product'}!\n\n`;
            
            if (description) {
                // Take the first 200 characters of description
                script += description.substring(0, 200) + '\n\n';
            }
            
            if (features) {
                script += 'Key Features:\n';
                const featuresList = features.split('\n').slice(0, 3);
                featuresList.forEach(feature => {
                    if (feature.trim()) {
                        script += `• ${feature.trim()}\n`;
                    }
                });
                script += '\n';
            }
            
            if (targetAudience) {
                script += `Perfect for ${targetAudience}.\n\n`;
            }
            
            script += `Get your ${productName || 'product'} today and experience the difference!`;
            
            return script;
        }

        function displayImages(images) {
            const container = document.getElementById('imagesPreview');
            container.innerHTML = '';
            
            if (!images || images.length === 0) {
                container.innerHTML = '<p style="color: #666;">No product images available</p>';
                return;
            }
            
            images.forEach((image, index) => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'image-thumbnail';
                imageDiv.innerHTML = `
                    <img src="${image.url}" alt="Product Image ${index + 1}">
                    <button class="remove-btn" onclick="removeImage(${index})">×</button>
                `;
                container.appendChild(imageDiv);
            });
        }

        function removeImage(index) {
            const imagesData = sessionStorage.getItem('generatedImages');
            if (imagesData) {
                let images = JSON.parse(imagesData);
                images.splice(index, 1);
                sessionStorage.setItem('generatedImages', JSON.stringify(images));
                displayImages(images);
            }
        }

        // Avatar selection
        document.querySelectorAll('.avatar-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.avatar-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                selectedAvatar = this.dataset.avatar;
                selectedVoice = this.dataset.voice;
                
                // Stop any ongoing preview when switching avatars
                if (isPlaying) {
                    stopPreview();
                }
            });
        });

        // Update word count
        document.getElementById('videoScript').addEventListener('input', updateWordCount);

        function updateWordCount() {
            const script = document.getElementById('videoScript').value;
            const wordCount = script.trim().split(/\s+/).filter(word => word.length > 0).length;
            document.getElementById('wordCount').textContent = wordCount;
            
            // Change color if over limit
            const countElement = document.getElementById('wordCount');
            if (wordCount > 500) {
                countElement.style.color = '#ff6b6b';
            } else {
                countElement.style.color = '#666';
            }
        }

        function togglePreview() {
            const script = document.getElementById('videoScript').value;
            if (!script.trim()) {
                alert('Please enter a script for your video');
                return;
            }
            
            if (!isPlaying) {
                startPreview();
            }
        }

        function startPreview() {
            const script = document.getElementById('videoScript').value;
            if (!script.trim()) {
                alert('Please enter a script for your video');
                return;
            }
            
            // Use speech synthesis with avatar-specific voice
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                speechSynthesis.cancel();
                
                speechSynthesisUtterance = new SpeechSynthesisUtterance(script);
                speechSynthesisUtterance.rate = parseFloat(document.getElementById('voiceSpeed').value);
                
                // Try to select voice based on avatar
                const voices = speechSynthesis.getVoices();
                const language = document.getElementById('voiceLanguage').value;
                
                // Map avatars to voice characteristics
                const voicePreferences = {
                    'anna': { gender: 'female', pitch: 1.1 },
                    'sophia': { gender: 'female', pitch: 1.0 },
                    'james': { gender: 'male', pitch: 0.9 },
                    'michael': { gender: 'male', pitch: 0.95 }
                };
                
                const preference = voicePreferences[selectedAvatar] || { gender: 'female', pitch: 1.0 };
                
                // Find matching voice
                let selectedVoiceObj = voices.find(voice => 
                    voice.lang.startsWith(language.split('-')[0]) &&
                    ((preference.gender === 'female' && (voice.name.includes('Female') || voice.name.includes('female') || voice.name.match(/Microsoft\s+(\w+\s+)?(?:Zira|Hazel|Susan|Linda|Heather|Catherine|Aria|Jenny)/i))) ||
                    (preference.gender === 'male' && (voice.name.includes('Male') || voice.name.includes('male') || voice.name.match(/Microsoft\s+(\w+\s+)?(?:David|Mark|George|Guy|Davis)/i))))
                );
                
                if (!selectedVoiceObj) {
                    // Fallback to any voice for the selected language
                    selectedVoiceObj = voices.find(voice => voice.lang.startsWith(language.split('-')[0]));
                }
                
                if (selectedVoiceObj) {
                    speechSynthesisUtterance.voice = selectedVoiceObj;
                }
                
                speechSynthesisUtterance.pitch = preference.pitch;
                
                // Update button states
                document.getElementById('playBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-flex';
                isPlaying = true;
                
                // Handle end of speech
                speechSynthesisUtterance.onend = function() {
                    document.getElementById('playBtn').style.display = 'inline-flex';
                    document.getElementById('stopBtn').style.display = 'none';
                    isPlaying = false;
                };
                
                speechSynthesis.speak(speechSynthesisUtterance);
            } else {
                alert('Speech synthesis not supported in your browser');
            }
        }

        function stopPreview() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            
            document.getElementById('playBtn').style.display = 'inline-flex';
            document.getElementById('stopBtn').style.display = 'none';
            isPlaying = false;
        }

        function previewScript() {
            // This function is now replaced by togglePreview
            togglePreview();
        }

        // Load voices when they become available
        if ('speechSynthesis' in window) {
            // Chrome loads voices asynchronously
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = function() {
                    speechSynthesis.getVoices();
                };
            }
            // Initial load
            speechSynthesis.getVoices();
        }

        async function generateVideo() {
            const script = document.getElementById('videoScript').value;
            if (!script.trim()) {
                alert('Please enter a script for your video');
                return;
            }

            const loading = document.getElementById('loading');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            loading.classList.add('active');
            progressBar.classList.add('active');
            
            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressFill.style.width = progress + '%';
                progressFill.textContent = Math.round(progress) + '%';
            }, 500);

            try {
                const response = await fetch('/api/generate-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        script: script,
                        avatar: selectedAvatar,
                        language: document.getElementById('voiceLanguage').value,
                        speed: document.getElementById('voiceSpeed').value,
                        duration: document.getElementById('videoDuration').value,
                        images: JSON.parse(sessionStorage.getItem('generatedImages') || '[]')
                    })
                });

                const data = await response.json();
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';

                if (data.success) {
                    // Display video
                    setTimeout(() => {
                        loading.classList.remove('active');
                        progressBar.classList.remove('active');
                        displayVideo(data.videoUrl);
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Failed to generate video');
                }
            } catch (error) {
                clearInterval(progressInterval);
                loading.classList.remove('active');
                progressBar.classList.remove('active');
                alert('Error generating video: ' + error.message);
            }
        }

        function displayVideo(videoUrl) {
            generatedVideoUrl = videoUrl;
            const videoElement = document.getElementById('generatedVideo');
            videoElement.src = videoUrl;
            document.getElementById('videoResult').classList.add('active');
            
            // Scroll to video
            document.getElementById('videoResult').scrollIntoView({ behavior: 'smooth' });
        }

        function downloadVideo() {
            if (generatedVideoUrl) {
                const a = document.createElement('a');
                a.href = generatedVideoUrl;
                a.download = 'product-video.mp4';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        function shareVideo() {
            if (generatedVideoUrl) {
                // Copy link to clipboard
                const dummy = document.createElement('input');
                document.body.appendChild(dummy);
                dummy.value = window.location.origin + generatedVideoUrl;
                dummy.select();
                document.execCommand('copy');
                document.body.removeChild(dummy);
                alert('Video link copied to clipboard!');
            }
        }
    </script>
</body>
</html>