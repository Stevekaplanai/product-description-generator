<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Your AI Video - ProductDescriptions.io</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        .success-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: bounce 1s ease;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .status-message {
            background: #f0f9ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .status-message.enterprise {
            background: linear-gradient(135deg, #fff9e6 0%, #fffdf7 100%);
            border: 2px solid #ffd700;
        }
        
        .product-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .product-info h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .product-info p {
            color: #666;
            line-height: 1.6;
        }
        
        .video-form {
            margin-top: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .create-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            width: 100%;
            margin-top: 20px;
        }
        
        .create-btn:hover {
            transform: scale(1.05);
        }
        
        .create-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .video-result {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: #f0f9ff;
            border-radius: 10px;
        }
        
        .video-result.active {
            display: block;
        }
        
        .video-player {
            width: 100%;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .download-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .download-btn:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="success-icon">üé¨</div>
        <h1>Create Your AI Product Video</h1>
        <div class="subtitle" id="subtitle">Ready to bring your product to life with AI video</div>
        
        <div class="status-message" id="statusMessage">
            <p><strong>‚úÖ Access Granted!</strong></p>
            <p id="planMessage">You have access to create AI videos for your product.</p>
        </div>
        
        <div class="product-info" id="productInfo">
            <h3>Product Details</h3>
            <p><strong>Product Name:</strong> <span id="productNameDisplay">Loading...</span></p>
            <p><strong>Description:</strong> <span id="productDescDisplay">Loading...</span></p>
        </div>
        
        <div class="video-form" id="videoForm">
            <h3>Video Preferences</h3>
            
            <div class="form-group">
                <label for="voiceType">Voice Type</label>
                <select id="voiceType">
                    <option value="female-professional">Female - Professional</option>
                    <option value="male-professional">Male - Professional</option>
                    <option value="female-friendly">Female - Friendly</option>
                    <option value="male-friendly">Male - Friendly</option>
                    <option value="female-energetic">Female - Energetic</option>
                    <option value="male-energetic">Male - Energetic</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="videoStyle">Video Style</label>
                <select id="videoStyle">
                    <option value="modern">Modern & Clean</option>
                    <option value="dynamic">Dynamic & Energetic</option>
                    <option value="elegant">Elegant & Sophisticated</option>
                    <option value="playful">Playful & Fun</option>
                    <option value="minimal">Minimal & Simple</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="videoDuration">Video Duration</label>
                <select id="videoDuration">
                    <option value="15">15 seconds</option>
                    <option value="30" selected>30 seconds</option>
                    <option value="60">60 seconds</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="customScript">Custom Script (Optional)</label>
                <textarea id="customScript" placeholder="Leave empty to auto-generate from your product description"></textarea>
            </div>
            
            <button class="create-btn" onclick="createVideo()">
                üé• Generate AI Video
            </button>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3>Creating Your Video...</h3>
            <p>This may take 1-2 minutes. Please don't close this page.</p>
        </div>
        
        <div class="video-result" id="videoResult">
            <h3>üéâ Your Video is Ready!</h3>
            <video class="video-player" id="videoPlayer" controls></video>
            <button class="download-btn" onclick="downloadVideo()">
                ‚¨áÔ∏è Download Video
            </button>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <a href="/app.html" class="back-link">‚Üê Back to Generator</a>
    </div>
    
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const isDirect = urlParams.get('direct') === 'true';
            const plan = urlParams.get('plan');
            const sessionId = urlParams.get('session_id');
            
            // Get stored product data
            const productName = sessionStorage.getItem('productName');
            const productDescription = sessionStorage.getItem('productDescription');
            const videoType = sessionStorage.getItem('videoType') || 'single';
            
            // Display product info
            if (productName) {
                document.getElementById('productNameDisplay').textContent = productName;
            }
            if (productDescription) {
                document.getElementById('productDescDisplay').textContent = productDescription.substring(0, 200) + '...';
            }
            
            // Update status based on plan
            if (plan === 'enterprise') {
                document.getElementById('statusMessage').className = 'status-message enterprise';
                document.getElementById('planMessage').innerHTML = 'üëë <strong>Enterprise Plan:</strong> Unlimited video creation included!';
                document.getElementById('subtitle').textContent = 'Your enterprise plan includes unlimited AI video generation';
            } else if (plan === 'professional') {
                document.getElementById('planMessage').innerHTML = 'üíé <strong>Professional Plan:</strong> Up to 50 videos per month included!';
                document.getElementById('subtitle').textContent = 'Your professional plan includes 50 videos per month';
            } else if (sessionId) {
                // User completed payment
                document.getElementById('planMessage').innerHTML = '‚úÖ <strong>Payment Successful!</strong> Your video credits are ready.';
                
                // Verify payment with backend
                try {
                    const response = await fetch('/api/verify-video-payment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Payment verification failed');
                    }
                } catch (error) {
                    console.error('Payment verification error:', error);
                }
            }
            
            // Auto-generate script from description
            if (productDescription && !document.getElementById('customScript').value) {
                generateAutoScript(productName, productDescription);
            }
        });
        
        function generateAutoScript(name, description) {
            // Create a concise script from the product description
            const script = `Introducing ${name}. ${description.substring(0, 150)}. Get yours today!`;
            document.getElementById('customScript').placeholder = script;
        }
        
        async function createVideo() {
            const voiceType = document.getElementById('voiceType').value;
            const videoStyle = document.getElementById('videoStyle').value;
            const videoDuration = document.getElementById('videoDuration').value;
            const customScript = document.getElementById('customScript').value;
            const productName = sessionStorage.getItem('productName');
            const productDescription = sessionStorage.getItem('productDescription');
            
            // Show loading
            document.getElementById('videoForm').style.display = 'none';
            document.getElementById('loading').className = 'loading active';
            document.getElementById('errorMessage').style.display = 'none';
            
            try {
                // Parse generated images from storage
                let images = [];
                try {
                    const storedImages = sessionStorage.getItem('generatedImages');
                    if (storedImages) {
                        images = JSON.parse(storedImages);
                    }
                } catch (e) {
                    console.log('No images found in storage');
                }
                
                // Map voice type to D-ID voice IDs
                const voiceMap = {
                    'female-professional': 'en-US-JennyNeural',
                    'male-professional': 'en-US-GuyNeural',
                    'female-friendly': 'en-US-AriaNeural',
                    'male-friendly': 'en-US-DavisNeural',
                    'female-energetic': 'en-US-SaraNeural',
                    'male-energetic': 'en-US-JasonNeural'
                };
                
                // Map avatar styles
                const avatarMap = {
                    'modern': 'amy-Aq6OmGZpMt',
                    'dynamic': 'josh-z3Y7JKX8Be',
                    'elegant': 'anna-gXa87QbXaP',
                    'playful': 'matt-e3wEQr5voi',
                    'minimal': 'alex-Xn5mJ3RKdC'
                };
                
                // Call video generation API
                const response = await fetch('/api/generate-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productName: productName || 'Product',
                        productDescription: customScript || productDescription || 'Amazing product',
                        features: '',
                        images: images,
                        avatar: avatarMap[videoStyle] || 'amy-Aq6OmGZpMt',
                        voice: voiceMap[voiceType] || 'en-US-JennyNeural',
                        generateProductShowcase: images.length > 0
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Video generation failed');
                }
                
                // Handle response based on what we got back
                if (data.videoUrl) {
                    // Show video result
                    document.getElementById('loading').className = 'loading';
                    document.getElementById('videoResult').className = 'video-result active';
                    
                    // Check if it's an actual video URL or an image URL
                    if (data.videoUrl.includes('.mp4') || data.videoUrl.includes('/video/')) {
                        document.getElementById('videoPlayer').src = data.videoUrl;
                    } else {
                        // If it's an image URL, show a message
                        document.getElementById('videoResult').innerHTML = `
                            <h3>üéâ Video Preview Generated!</h3>
                            <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                <p><strong>Product:</strong> ${data.productName}</p>
                                <p><strong>Status:</strong> ${data.message}</p>
                                <p style="color: #667eea; margin-top: 10px;">
                                    ${data.note || 'Your video has been generated as a preview. Full video generation with AI avatars requires D-ID API configuration.'}
                                </p>
                            </div>
                            <a href="${data.videoUrl}" target="_blank" class="download-btn">
                                View Generated Content
                            </a>
                        `;
                    }
                    
                    // Store video URL for download
                    window.currentVideoUrl = data.videoUrl;
                } else if (data.demoMode) {
                    // Show demo mode message
                    document.getElementById('loading').className = 'loading';
                    document.getElementById('videoForm').style.display = 'block';
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('errorMessage').innerHTML = `
                        <strong>Demo Mode:</strong> Video generation is configured but requires active API keys.<br>
                        Script generated: "${data.script}"<br>
                        <small>Contact support to enable full video generation.</small>
                    `;
                } else {
                    throw new Error('No video URL returned');
                }
                
            } catch (error) {
                console.error('Video creation error:', error);
                document.getElementById('loading').className = 'loading';
                document.getElementById('videoForm').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = `Failed to create video: ${error.message}. Please try again or contact support.`;
            }
        }
        
        function downloadVideo() {
            if (window.currentVideoUrl) {
                const a = document.createElement('a');
                a.href = window.currentVideoUrl;
                a.download = `product-video-${Date.now()}.mp4`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }
    </script>
</body>
</html>